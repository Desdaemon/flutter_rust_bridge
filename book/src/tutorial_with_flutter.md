# Tutorial: A Flutter+Rust app

In this tutorial, let us draw a [Mandelbrot set](https://en.wikipedia.org/wiki/Mandelbrot_set), which is plotted in Flutter UI, generated by Rust algorithm, and communicated via this library.

**Remark**: The `flutter_*_test` sections of the [CI workflow](https://github.com/fzyzcjy/flutter_rust_bridge/blob/master/.github/workflows/test.yaml) can also be useful, if you want details of each command.

## Get example code

Please [install Flutter](https://flutter.dev/docs/get-started/install), [install Rust](https://www.rust-lang.org/learn/get-started), and have some familiarity with them. Then run `git clone https://github.com/fzyzcjy/flutter_rust_bridge`, and my example is in `frb_example/with_flutter`.

## (Optional) Run code generator

I have generated the source code already (in quickstart), so this step is optional. Even if you do it, you should not see anything changed.

Install it: `cargo install flutter_rust_bridge_codegen`.

Run it:

```
flutter_rust_bridge_codegen --rust-input frb_example/with_flutter/rust/src/api.rs --dart-output frb_example/with_flutter/lib/bridge_generated.dart --c-output frb_example/with_flutter/ios/Runner/bridge_generated.h
```

<sub>**Remark**: If you have problems, see "Troubleshooting" section. For Windows, you may need `\\` instead of `/` for paths.</sub>

## Run "Flutter+Rust" app

### If Android

Run `cargo ndk -o ../android/app/src/main/jniLibs build`. Then run the Flutter app normally as is taught in official tutorial. For example, `flutter run`.

Remark: Since my quickstart app is so baremetal, I do not integrate the Rust building process into Flutter building process. But you can look at [this tutorial](https://stackoverflow.com/q/69515032/4619958) to easily do that.

### If iOS

Modify `Cargo.toml` to change `cdylib` to `staticlib`. (Again, this is baremetal example so it is done manually. For your project, you can automate it.)

Run `cargo lipo && cp target/universal/debug/libflutter_rust_bridge_example.a ../ios/Runner` to build Rust and copy the static library. Then run the Flutter app normally as is taught in official tutorial. For example, `flutter run`. (Similarly, [this tutorial](https://stackoverflow.com/q/69515032/4619958) can automate the process.)

### If Desktop (Windows/Linux/MacOS)

**Remark**: If you only want to develop a mobile app, skip this section - it is for creating desktop apps.

Run it directly using `flutter run` assuming [Flutter desktop support](https://flutter.dev/desktop#set-up) has been configured. 

Flutter can run on Windows/Linux/MacOS without any problem, and this lib does nothing but generates some code like a human being. Therefore, this package should work well as long as you set up the Flutter desktop app's ffi functionality successfully.

#### Windows/Linux
This example (`frb_example/with_flutter`) already demonstrated how to integrate Cargo with CMake on Linux and Windows, and more details can be seen in [#66](https://github.com/fzyzcjy/flutter_rust_bridge/issues/66).

#### MacOS
To integrate a dynamic library to your macOS app, you need to configure your `Runner.xcworkspace` in Xcode. Here, I show the instructions for Xcode 13.1:
1. Open the `yourapp/macos/Runner.xcworkspace` in Xcode.
2. Drag your precompiled library (`libyourlibrary.dylib`) into `Runner/Frameworks`.
3. Click `Runner` (with a blue app store logo on the left, not the folder underneath) and go to the `Build Phases` tab.
    1. Drag `libyourlibrary.dylib` into the `Copy Bundle Resources` list.
    2. Under `Bundle Frameworks`, drag `libyourlibrary.dylib`  to the list, `Code sign on copy` should be checked by default.
    3. Under `Link Binary With Libraries`, set status of `libyourlibrary.dylib` to Optional. (We use dynamic linking, no need to statically link.)
4. Click `Runner` and go to the `General` tab.
    1. You should see `libyourlibrary.dylib` in the `Frameworks, Libararies and Embedded Content` list, with the option saying `Embed & Sign`.
    2. If not, drag your library to the list and select the option.
5. Click `Runner` and go to the `Build Settings` tab.
    1. In the `Search Paths` section configure the `Library Search Paths` to include the absolute path where libyourlibrary.dylib is located.

In `lib/main.dart`, you can now use `DynamicLibrary.open('libyourlibrary.dylib')` to dynamically link to the symbols. This example app shows how to do dynamic linking on other platforms as well so be sure to take a look at `frb_example/with_flutter/lib/main.dart`.
Reference the [flutter documentation](https://docs.flutter.dev/development/platform-integration/c-interop#compiled-dynamic-library-macos) for details, do note that the Xcode version they demonstrates in may not be the latest.

## (Optional) See more types that this library can generate

Have a look at the function arguments and return types in this file: [api.rs](https://github.com/fzyzcjy/flutter_rust_bridge/blob/master/frb_example/pure_dart/rust/src/api.rs). With this library, we have a generated API that resides at [generated_api.dart](https://github.com/fzyzcjy/flutter_rust_bridge/blob/master/frb_example/pure_dart/dart/lib/generated_api.dart) (of course, that is auto generated, and you can use it in other Dart code).

## (Optional) Remarks

### The `mod`

If you are adding this lib to your own existing code, please put `mod generated_wire;` (where `generated_wire` is the name of the wire file that you choose) into your `lib.rs` or `main.rs`. Only by doing this, Rust can understand that this generated file is a part of your project.

### Version

Dart SDK `>=2.14.0` is needed not by this library, but by the latest version of the `ffigen` tool. Therefore, write `sdk: ">=2.14.0 <3.0.0"` in the `environment` section of `pubspec.yaml`. If you do not want that, consider installing a older version of the `ffigen` tool.

### Setup from scratch

To set up Flutter/Dart+Rust support from scratch by yourself, have a look at [set_up_from_scratch](set_up_from_scratch.md).